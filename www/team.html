<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Team View ‚Äì DnD Blockchain</title>
    <style>
        body {
            background: #141414;
            color: #eee;
            font-family: sans-serif;
            margin: 20px 40px;
        }

        h1, h2 {
            margin-bottom: 10px;
        }

        .row {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: #222;
            border-radius: 12px;
            padding: 16px 20px;
            flex: 1;
            min-width: 0;
        }

        .card h2 {
            margin-top: 0;
            font-size: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }

        th, td {
            padding: 6px 4px;
            border-bottom: 1px solid #444;
            font-size: 14px;
        }

        th {
            text-align: left;
            color: #bbb;
        }

        .hp-bar {
            height: 10px;
            border-radius: 4px;
            background: #444;
            overflow: hidden;
        }

        .hp-bar-inner {
            height: 100%;
            background: #3fbf3f;
        }

        select, button {
            background: #333;
            color: #eee;
            border-radius: 6px;
            border: 1px solid #555;
            padding: 6px 10px;
            font-size: 14px;
        }

        button {
            cursor: pointer;
            background: #3a7bd5;
            border: none;
            padding: 8px 14px;
            margin-left: 8px;
        }

        .timeline {
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 13px;
        }

        .timeline-entry {
            border-bottom: 1px solid #444;
            padding: 4px 0;
        }

        .tag-hit {
            color: #3fe03f;
        }

        .tag-miss {
            color: #ff6666;
        }

        .tag-round {
            color: #ffcc66;
        }
    </style>
</head>
<body>

<h1>üõ° Team View ‚Äì On-Chain DnD State</h1>

<div class="row">
    <!-- CHARACTERS -->
    <div class="card">
        <h2>üë§ Characters (HP from Blockchain State)</h2>
        <button id="btnRefreshState">Refresh State</button>
        <table id="charactersTable">
            <!-- filled by JS -->
        </table>
    </div>

    <!-- MONSTERS -->
    <div class="card">
        <h2>üêâ Monsters</h2>
        <table id="monstersTable">
            <!-- filled by JS -->
        </table>
    </div>
</div>

<!-- ENCOUNTERS + TIMELINE -->
<div class="card">
    <h2>üìú Encounter Timeline (from Events on Chain)</h2>

    <div style="margin-bottom: 10px;">
        <label for="encounterSelect">Encounter:</label>
        <select id="encounterSelect"></select>
        <button id="btnLoadEncounter">Load Timeline</button>
    </div>

    <div class="timeline" id="timeline"></div>
</div>

<script src="teamApi.js"></script>

<script>
// ---- DOM helpers ----
function renderHpCell(hpCur, hpMax) {
    const pct = hpMax > 0 ? Math.max(0, Math.min(100, Math.round(hpCur * 100 / hpMax))) : 0;
    return `
        ${hpCur} / ${hpMax}
        <div class="hp-bar">
          <div class="hp-bar-inner" style="width:${pct}%"></div>
        </div>
    `;
}

// ---- State refresh ----
async function refreshState() {
    const state = await teamApi.getDndState();

    const chars = state.characters || {};
    const mons  = state.monsters || {};
    const encs  = state.encounters || {};

    // Characters table
    const cTable = document.getElementById("charactersTable");
    cTable.innerHTML = "<tr><th>Name</th><th>HP</th><th>AC</th><th>Level</th></tr>";

    Object.values(chars).forEach(c => {
        cTable.innerHTML += `
            <tr>
                <td>${c.name || c.id}</td>
                <td>${renderHpCell(c.hpCurrent, c.hpMax)}</td>
                <td>${c.armorClass ?? "-"}</td>
                <td>${c.level ?? "-"}</td>
            </tr>
        `;
    });

    // Monsters table
    const mTable = document.getElementById("monstersTable");
    mTable.innerHTML = "<tr><th>Name</th><th>HP</th><th>AC</th></tr>";

    Object.values(mons).forEach(m => {
        mTable.innerHTML += `
            <tr>
                <td>${m.name || m.id}</td>
                <td>${renderHpCell(m.hpCurrent, m.hpMax)}</td>
                <td>${m.armorClass ?? "-"}</td>
            </tr>
        `;
    });

    // Encounter select
    const sel = document.getElementById("encounterSelect");
    sel.innerHTML = "";
    Object.values(encs).forEach(e => {
        const label = `${e.id} ‚Äì ${e.name || ""} (Round ${e.round ?? "?"})`;
        const opt = document.createElement("option");
        opt.value = e.id;
        opt.textContent = label;
        sel.appendChild(opt);
    });
}

// ---- Timeline load ----
async function loadEncounter() {
    const sel = document.getElementById("encounterSelect");
    const encId = sel.value;
    if (!encId) return;

    const detail = await teamApi.getEncounter(encId);
    const enc    = detail.encounter || {};
    const events = detail.events || [];

    const timeline = document.getElementById("timeline");
    timeline.innerHTML = "";

    timeline.innerHTML += `
        <div class="timeline-entry">
            <span class="tag-round">Encounter:</span> ${enc.id} ‚Äì ${enc.name || ""}, Round ${enc.round ?? "?"}
        </div>
    `;

    events.forEach(ev => {
        const hitTag = ev.hit ? `<span class="tag-hit">HIT</span>` : `<span class="tag-miss">MISS</span>`;
        const dmg    = ev.damage ?? 0;
        const note   = ev.note ? `(${ev.note})` : "";
        const time   = ev.timestamp ? new Date(ev.timestamp * 1000).toLocaleTimeString() : "";

        timeline.innerHTML += `
            <div class="timeline-entry">
                <span class="tag-round">R${ev.round ?? "?"}</span>
                [${time}] ${ev.actorId} ‚Üí ${ev.targetId}
                | roll=${ev.roll ?? "?"}, dmg=${dmg} ${hitTag} ${note}
            </div>
        `;
    });

    if (events.length === 0) {
        timeline.innerHTML += `
            <div class="timeline-entry">
                (No events yet for this encounter)
            </div>
        `;
    }
}

// ---- Wiring ----
document.getElementById("btnRefreshState").onclick = refreshState;
document.getElementById("btnLoadEncounter").onclick = loadEncounter;

// initial load
refreshState();
</script>

</body>
</html>

